<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<title>

  Generating a JS API from Rails Routes ¬∑ M√°ximo Mussini

</title>

<meta name="author" content="M√°ximo Mussini">
<meta name="description" content="One idea I‚Äôve always appreciated about the routing approach in Rails is path helpers, which are automatically generated from route definitions.

Some advantages of using path helpers are:

  There‚Äôs no need to take care of manually interpolating ids and parameters to
build a String URL.
  Any change to the route ‚Ä¶
">
<meta name="keywords" content="rails, http, ajax, api, js">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="cleartype" content="on">
<meta name="theme-color" content="#5C7E8F" />

<!-- Styles -->
<link rel="preconnect" href="//fonts.googleapis.com">
<link rel="preconnect" href="//www.google-analytics.com">
<link rel="preload" href="//fonts.googleapis.com/css?family=Raleway:700,800,900|Lato:400,400italic,700,900&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'" onerror="this.rel='stylesheet'" type="text/css" media="screen, projection">
<link rel="stylesheet" href="/assets/css/styles.css?v=4" media="screen, projection">

<!-- Icons -->
<link rel="shortcut icon" href="/favicon.ico">
<link rel="icon" sizes="192x192" href="/icon.png">
<link rel="apple-touch-icon" href="/apple-touch-icon.jpg">
<link rel="alternate" type="application/atom+xml" href="/feed.xml" title="M√°ximo Mussini ¬∑ Code and Design">

<!-- Facebook Stuff -->
<meta property="og:type" content="website">
<meta property="og:locale" content="en_US">
<meta property="og:url" content="http://maximomussini.com/posts/js-from-routes/">
<meta property="og:site_name" content="M√°ximo Mussini">
<meta property="og:title" content="Generating a JS API from Rails Routes">
<meta property="og:image" content="http://maximomussini.com/images/posts/js-from-routes.jpg">
<meta property="og:description" content="One idea I‚Äôve always appreciated about the routing approach in Rails is path helpers, which are automatically generated from route definitions.

Some advantages of using path helpers are:

  There‚Äôs no need to take care of manually interpolating ids and parameters to
build a String URL.
  Any change to the route ‚Ä¶
">

<!-- Twitter Stuff -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:domain" value="maximomussini.com" />
<meta name="twitter:title" value="Generating a JS API from Rails Routes" />
<meta name="twitter:description" value="One idea I‚Äôve always appreciated about the routing approach in Rails is path helpers, which are automatically generated from route definitions.

Some advantages of using path helpers are:

  There‚Äôs no need to take care of manually interpolating ids and parameters to
build a String URL.
  Any change to the route ‚Ä¶
" />
<meta name="twitter:image" content="http://maximomussini.com/images/posts/js-from-routes.jpg" />
<meta name="twitter:url" value="http://maximomussini.com/posts/js-from-routes/" />

  </head>
  <body>
    <header style="background-image: url('data:image/webp;base64,UklGRqQCAABXRUJQVlA4IJgCAABQFQCdASoaAWQAPtFkqE8/r6yppzSa2/AaCWNu4DroB6sCtl3nfb+VQDQtz/9WT/9Qc4HZtBBhP6qpM9CZzF24UBnJdk8LPmHkbYq0yrusUzEFIX7y/W9dTQE6YhIUdNkbyWQA1XZuYBucZviHgaJacFzsvfUD2fVeRaiQtUPRNL+HM4RQrOhiSsjY3dZuiMnkuPJLEv5Fiop/4CFdy4AOVdElkupBQSNhCR+vyWu+KPsvgAD+wXcKP5mxo1wP99fCbZNij2umc2hJx0g2ZopYsMhs+rOupsGsxZcMwFC9MQl6wfh5e0r19IAu2m2eNBRkfgSC56GBipMz9Djjgbui5+t4KZrOAbI6kyQVE3HSRUN+sug3T0ToXtl7LDuEip/A95FNTrgUOq0R/ujV7nXM2spYQxrXRUfTLxf3xedhFJxjdQTPwY9+FVawcspjwetwAta+gp9tXoJBw5v0KI8D2eeZjepWxiSoJMi07VRN0M3+1nbdcKjH735Z8yH10ZK23kM2CalwWTcux3u+BZoSAqyYeQuAsYTBZy6zHADHYxscDngltVNvWRRVAF/3K54EdDuy3JDLPvB6AO40HNc/y8ZjXYTnfr2nO8s3y4hgWBUFJ4/y15hhUMEzabzK4DYbxXr73N5UH8FwdtcAyCYIsZhGg8n75+AaPXqTUcpVYxmWe8UGbJN95wPvqmMgFheXaE38iyVr2DnaaHMJxpvXBra7fggA+LYeVCdAFd0drLsqBwWV358jilR/4nkkk0iZTsGBhEW6R8lu4lvnEgF8ANEA7YrRe/nn1Ql0v68pyBIZ8i5WeIZEQThBy2QOM6yvp2ZUgynl6AB63BhRmNzKug2BFIK3Sw/xf5WPWIt4s4WQm2kLAAAA')">
  
    <div class="hero">
      <picture>
  <source srcset="/images/posts/js-from-routes.webp" type="image/webp" media="(min-width: 600px)">
  <source srcset="/images/posts/js-from-routes-500.webp" type="image/webp">
  <img src="/images/posts/js-from-routes.jpg" alt="js-from-routes.jpg" class="hero-bg">
</picture>

      <h1 class="hero-title">Generating a JS API from Rails Routes</h1>
    </div>
  
</header>

    <div class="menu container">
  <ul>
    
<li>
  <a href="/about/">About</a>
</li>

    
<li>
  <a href="/posts/">Posts</a>
</li>

    <li>
      <a href="/" class="logo">
  <img class="logo-img" src="/assets/icons/logo.svg" alt="Logo"/>
</a>

    </li>
    
<li>
  <a href="/projects/">Projects</a>
</li>

    
<li>
  <a href="/talks/">Talks</a>
</li>

  </ul>
  <hr />
</div>

    <div class="content container">
  

  <div class="post-info">
  <span class="date">June 22, 2020</span>
  <span class="reading-time">5 min read</span>
</div>


  <div class="post">
    <p>One idea I‚Äôve always appreciated about the routing approach in Rails is <strong>path helpers</strong>, which are automatically generated from route definitions.</p>

<p>Some advantages of using path helpers are:</p>
<ul>
  <li>There‚Äôs no need to take care of manually interpolating ids and parameters to
build a <code class="language-plaintext highlighter-rouge">String</code> URL.</li>
  <li>Any change to the route definition affects the helper, so if a route is
removed or modified, the path helper is no longer available.</li>
  <li>Code that uses an outdated path helper causes a runtime error, which can be
detected by integration or unit tests, instead of rendering a path that would
end up in a 404, like it would happen when using manual string interpolation.</li>
</ul>

<h2 id="path-helpers-in-js">Path Helpers in JS</h2>
<p>Traditionally, frontend code in Rails replicates the path structure as defined in the backend, hardcoding the paths for every endpoint that needs to be accessed, and specifying HTTP verbs as needed (<code class="language-plaintext highlighter-rouge">GET</code>, <code class="language-plaintext highlighter-rouge">POST</code>, <code class="language-plaintext highlighter-rouge">PATCH</code>).</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">$</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/search</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="nx">query</span> <span class="p">})</span>
</code></pre></div></div>

<p>This approach is very cumbersome, and it is possible to introduce typos, or
make mistakes like choosing the wrong HTTP verb (<code class="language-plaintext highlighter-rouge">PUT</code> instead of <code class="language-plaintext highlighter-rouge">PATCH</code>, and so on).</p>

<blockquote>
  <p>We could avoid these problems if we had path helpers in JS.</p>
</blockquote>

<p>While some tools that allowed to expose path helpers to JS already existed, they were created when <a href="https://github.com/rails/sprockets">sprockets</a> was <em>the</em> way to compile frontend assets in Rails, long before the <a href="https://github.com/rails/webpacker">Webpack</a> era.</p>

<p>I wanted a solution that provided an enjoyable front-end development experience. One that could leverage Webpack loaders and aliases, and was based on ES6 modules to allow tree-shaking, was easy to inspect, and where changes could be tracked under version control.</p>

<p>And that‚Äôs why I created <a href="https://github.com/ElMassimo/js_from_routes"><code class="language-plaintext highlighter-rouge">JsFromRoutes</code></a>.</p>

<h3 id="shaping-the-vision-">Shaping the Vision ‚ú®</h3>
<p>From a developer‚Äôs UX perspective, the goal was to simplify how to make <a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API">requests</a> to a Rails API.</p>

<p>This meant not thinking about paths, parameter interpolation, nor HTTP verbs. Just plain function calls and promises.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">UsersRequests</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@requests/UsersRequests</span><span class="dl">'</span>

<span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">UsersRequests</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">email</span> <span class="p">})</span>
</code></pre></div></div>

<p>These functions would be automatically generated from the Rails route definitions. The generation process should be transparent, and happen automatically as routes are added and the application is reloaded.</p>

<p>For maintainability, as well as for tree-shaking purposes, it was desirable to do a simple mapping: <em>one request object per controller</em>.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">request</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@services/ApiService</span><span class="dl">'</span>

<span class="k">export</span> <span class="k">default</span> <span class="p">{</span>
  <span class="na">search</span><span class="p">:</span> <span class="nx">options</span> <span class="o">=&gt;</span>
    <span class="nx">request</span><span class="p">(</span><span class="dl">'</span><span class="s1">get</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">/users/search</span><span class="dl">'</span><span class="p">,</span> <span class="nx">options</span><span class="p">),</span>

  <span class="na">create</span><span class="p">:</span> <span class="nx">options</span> <span class="o">=&gt;</span>
    <span class="nx">request</span><span class="p">(</span><span class="dl">'</span><span class="s1">post</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">/users</span><span class="dl">'</span><span class="p">,</span> <span class="nx">options</span><span class="p">),</span>

  <span class="na">destroy</span><span class="p">:</span> <span class="nx">options</span> <span class="o">=&gt;</span>
    <span class="nx">request</span><span class="p">(</span><span class="dl">'</span><span class="s1">delete</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">/users/:id</span><span class="dl">'</span><span class="p">,</span> <span class="nx">options</span><span class="p">),</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Delegating the actual request to an existing service would allow to keep the generated code lean. Any changes or improvements could then be made on the service itself, without having to regenerate the code. For example, switching from <a href="https://github.com/axios/axios">axios</a> to <a href="https://github.com/developit/redaxios">redaxios</a>, or to the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API">fetch API</a>.</p>

<h3 id="generating-js-from-rails-routes-Ô∏è">Generating JS from Rails Routes ‚öôÔ∏è</h3>

<p>Although the routes DSL in Rails wasn‚Äôt designed for inspection purposes, it does provide
the necessary metadata: the name of the endpoints, the HTTP verbs, and the paths including named parameters.</p>

<p>By doing some slight processing to the information in <code class="language-plaintext highlighter-rouge">Rails.application.routes</code>, and combining that with an ERB template, we are able to generate the JS functions we need.</p>

<div class="language-erb highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import { request } from '@services/ApiService'

export default {
<span class="cp">&lt;%</span> <span class="n">routes</span><span class="p">.</span><span class="nf">each_with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">route</span><span class="p">,</span> <span class="n">index</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">route</span><span class="p">.</span><span class="nf">helper</span> <span class="cp">%&gt;</span>: options =&gt;
    request('<span class="cp">&lt;%=</span> <span class="n">route</span><span class="p">.</span><span class="nf">verb</span> <span class="cp">%&gt;</span>', '<span class="cp">&lt;%=</span> <span class="n">route</span><span class="p">.</span><span class="nf">path</span> <span class="cp">%&gt;</span>', options),
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
}
</code></pre></div></div>

<h3 id="automating-the-flow-">Automating the Flow ü§ñ</h3>
<p>Why trigger the generation manually? Let the machines do it üòÉ</p>

<p>By adding a hook to Rails‚Äô reload process in development, we can automatically
generate files from routes when a route is added, modified, or removed.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Reloader</span><span class="p">.</span><span class="nf">to_prepare</span> <span class="p">{</span> <span class="no">JsFromRoutes</span><span class="p">.</span><span class="nf">generate!</span> <span class="p">}</span>
</code></pre></div></div>

<p>In order to optimize file generation, we split the generated JS files by
controller, and add a cache key based on the routes to avoid rewriting the file
if the route definition hasn‚Äôt changed.</p>

<p>When the Webpack development server is running, this automatically triggers a
new build, and our request method or path helper is ready to be used!</p>

<h3 id="the-gem-">The Gem üíé</h3>

<p>The flow described above is now available through the <a href="https://github.com/ElMassimo/js_from_routes"><code class="language-plaintext highlighter-rouge">js_from_routes</code></a> gem. The library provides additional configuration options, <a href="https://github.com/ElMassimo/js_from_routes">visit the readme</a> for more information.</p>

<p>This approach has similar benefits to path helpers in Rails:</p>

<ul>
  <li>No need to manually specify the URL, preventing mistakes and saving development time.</li>
  <li>If an action is renamed or removed, the helper ceases to exist, which causes an error that is easier to detect than a 404.</li>
  <li>The HTTP verb is embedded in the helper, so it‚Äôs transparent for the client code. Changing the verb in the route causes the JS code to be regenerated, no need to update the consumers!</li>
</ul>

<h2 id="summary">Summary</h2>
<p><a href="https://github.com/ElMassimo/js_from_routes"><code class="language-plaintext highlighter-rouge">js_from_routes</code></a> allows to automatically generate path and API helpers from Rails route definitions, allowing you to save development effort and focus on the things that matter.</p>

<p>Since introducing this tool, we have saved a lot of time that we would have
spent writing boilerplate code, avoided a lot of mistakes like typos and
interpolation errors, and made the front-end development experience more
enjoyable üòÉ</p>


  </div>

  <div class="ending">
  <a href="/" class="logo">
  <img class="logo-img" src="/assets/icons/logo.svg" alt="Logo"/>
</a>

  <span>by</span>
  <a href="https://twitter.com/MaximoMussini" class="author-name">M√°ximo<span class="last-name"> Mussini</span></a>
  <a class="twitter-share-button" href="//twitter.com/intent/tweet?original_referer=http://maximomussini.com/posts/js-from-routes/&amp;ref_src=twsrc%5Etfw&amp;text=Generating a JS API from Rails Routes%20%C2%B7%20M%C3%A1ximo%20Mussini&amp;tw_p=tweetbutton&amp;url=http://maximomussini.com/posts/js-from-routes/&amp;via=MaximoMussini" rel="noopener" target="_blank"><i class="twitter-icon"></i><span class="twitter-label">Tweet</span></a>

</div>

</div>



  <a id="next-post" href="/posts/understanding-the-singleton-class/" class="hidden"></a>




  <a id="previous-post" href="/posts/vuex-stores/" class="hidden"></a>




  <div class="related-post">
    <div class="content container">
      <a id="related-post" href="/posts/rails-ajax_redirect/" class="overlay">
        <h1>Redirecting AJAX requests in Rails</h1>
        <div class="post-info">
  <span class="date">January 11, 2016</span>
  <span class="reading-time">2 min read</span>
</div>

        <div class="post">
          <p><span href="https://github.com/rails/jquery-rails"><code class="language-plaintext highlighter-rouge">jquery-rails</code></span> powers links and forms in Rails: it‚Äôs what makes <code class="language-plaintext highlighter-rouge">remote: true</code> work, allowing any link to make an AJAX request unobtrusively.</p>

<p><span href="https://github.com/ElMassimo/rails-ajax_redirect"><code class="language-plaintext highlighter-rouge">rails-ajax_redirect</code></span> is an extension to this unobtrusive behaviour that adds AJAX support to <code class="language-plaintext highlighter-rouge">redirect_to</code>. It allows us to redirect an AJAX request as usual, instead of having to perform the redirect by handling the response manually in JS every time.</p>

<p>This is helpful in many different scenarios, and ju‚Ä¶</p>
        </div>
      </a>
    </div>
  </div>



    <script>
if (document.location.hostname.search('maximomussini.com') !== -1) {
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-67510525-1', 'auto');
  ga('send', 'pageview');
}
</script>

<script src="/assets/js/anchors.js" async></script>
<script src="/assets/js/shortcuts.js" async></script>

  </body>
</html>
